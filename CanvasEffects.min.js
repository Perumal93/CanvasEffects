(function(q){var x=q.document,g=q.Math,m=function(a,b){for(var c in b)a[c]=b[c]},j=function(a,b){if(!a)throw Error(b||"");},l=function(a,b){j("canvas"===a.nodeName.toLowerCase(),"A canvas element is excepted.");var c={width:a.width,height:a.height,useWorker:"function"===typeof Worker,workerPath:"CanvasEffects.worker.js"};m(c,b);this.width=c.width;this.height=c.height;var d=x.createElement("canvas");d.width=this.width;d.height=this.height;this.ctx=a.getContext("2d");this.tmpCtx=d.getContext("2d");
if(c.useWorker){var e=this;this._queue=[];this.worker=new Worker(c.workerPath);this.worker.onmessage=function(a){var c=e.createImageData(e.width,e.height);if("undefined"===typeof Uint8ClampedArray)for(var b=0;b<a.data.length;b++)c.data[b]=a.data[b];else c.data.set(a.data);for(b=0;b<e._queue.length;b++)c.data=e._queue[b](c.data);e._queue=[];e.ctx.clearRect(0,0,e.width,e.height);e.ctx.putImageData(c,0,0)};this.worker.postMessage({type:"init",w:this.width,h:this.height})}};m(l.prototype,{load:function(a,
b){b=b||!0;var c=new Image,d=this;c.onload=function(){b?(d.ctx.drawImage(this,0,0,this.width,this.height,0,0,d.width,d.height),d.tmpCtx.drawImage(this,0,0,this.width,this.height,0,0,d.width,d.height)):(d.ctx.drawImage(this,0,0,this.width,this.height),d.tmpCtx.drawImage(this,0,0,this.width,this.height))};c.crossOrigin=!0;c.src=a;return this},restore:function(){this.ctx.clearRect(0,0,this.width,this.height);this.ctx.drawImage(this.tmpCtx.canvas,0,0,this.width,this.height);return this},save:function(){this.tmpCtx.clearRect(0,
0,this.width,this.height);this.tmpCtx.drawImage(this.ctx.canvas,0,0,this.width,this.height);return this},toDataURL:function(){return this.ctx.canvas.toDataURL()},process:function(a){for(var b=this.ctx.getImageData(0,0,this.width,this.height),c=0;c<this.width;c++)for(var d=0;d<this.height;d++){var e=4*(d*this.width+c),f=a(b.data[e],b.data[e+1],b.data[e+2],b.data[e+3],c,d);b.data[e]=f[0];b.data[e+1]=f[1];b.data[e+2]=f[2];b.data[e+3]=f[3]}this.ctx.clearRect(0,0,this.width,this.height);this.ctx.putImageData(b,
0,0);return this},getContext:function(){return this.ctx},luminance:function(a,b,c){return 0.2126*a+0.7152*b+0.0722*c},createImageData:function(a,b){return this.tmpCtx.createImageData(a,b)},toHSL:function(a,b,c){a/=255;b/=255;c/=255;var d=g.max(a,b,c),e=g.min(a,b,c),f,h=(d+e)/2;if(d===e)f=e=0;else{var k=d-e,e=0.5<h?k/(2-d-e):k/(d+e);switch(d){case a:f=(b-c)/k+(b<c?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}}return{h:f/6,s:e,l:h}},toRGB:function(a,b,c){if(0==b)c=b=a=c;else{var d=function(a,
b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-c):a},e=0.5>c?c*(1+b):c+b-c*b,f=2*c-e;c=d(f,e,a+1/3);b=d(f,e,a);a=d(f,e,a-1/3)}return{r:255*c,g:255*b,b:255*a}},colorTempToRGB:function(a){a/=100;var b,c;66>=a?(b=255,c=g.min(g.max(99.4708025861*g.log(a)-161.1195681661,0),255)):(b=g.min(g.max(329.698727446*g.pow(a-60,-0.1332047592),0),255),c=g.min(g.max(288.1221695283*g.pow(a-60,-0.0755148492),0),255));a=66<=a?255:19>=a?0:g.min(g.max(138.5177312231*g.log(a-10)-305.0447927307,
0),255);return{r:b,g:c,b:a}},_toWorker:function(a){if(this.worker)return m(a,{data:this.ctx.getImageData(0,0,this.width,this.height).data}),this.worker.postMessage(a),this;j(!1,"No web worker support!")},queue:function(a){if(this.worker)this._queue.push(a);else{var b=this.ctx.getImageData(0,0,this.width,this.height);b.data=a(b.data);this.ctx.putImageData(b,0,0)}return this}});m(l.prototype,{greyscale:function(a){a=void 0===a?1:g.min(g.max(a,0),1);var b=this;return this.process(function(c,d,e,f){var g=
b.luminance(c,d,e);return[g*a+c*(1-a),g*a+d*(1-a),g*a+e*(1-a),f]})},threshold:function(a){a=a||127;var b=this;return this.process(function(c,d,e,f){c=b.luminance(c,d,e)>a?255:0;return[c,c,c,f]})},invert:function(a){a=void 0===a?1:g.min(g.max(a,0),1);return this.process(function(b,c,d,e){return[(255-b)*a+b*(1-a),(255-c)*a+c*(1-a),(255-d)*a+d*(1-a),e]})},sepia:function(a){a=void 0===a?1:g.min(g.max(a,0),1);return this.process(function(b,c,d,e){return[(0.393*b+0.769*c+0.189*d)*a+b*(1-a),(0.349*b+0.686*
c+0.168*d)*a+c*(1-a),(0.272*b+0.534*c+0.131*d)*a+d*(1-a),e]})}});m(l.prototype,{noise:function(a,b){j(0<=a,"Noise amount must be a positive number.");b=b||!1;return this.process(function(c,d,e,f){var h=-a/2+2*g.random()*a;return[c+h,d+h,e+h,b?f+h:f]})},glow:function(a){var b=this;this.blur(a);return this.queue(function(a){for(var d=b.ctx.getImageData(0,0,b.width,b.height),e=0;e<a.length;e+=4)a[e]=255-(255-a[e])*(255-d.data[e])/255,a[e+1]=255-(255-a[e+1])*(255-d.data[e+1])/255,a[e+2]=255-(255-a[e+
2])*(255-d.data[e+2])/255,a[e+3]=255-(255-a[e+3])*(255-d.data[e+3])/255;return a})},colorMatrix:function(a){return this.process(function(b,c,d,e){return[b*a[0]+c*a[1]+d*a[2]+e*a[3]+255*a[20],b*a[5]+c*a[6]+d*a[7]+e*a[8]+255*a[21],b*a[10]+c*a[11]+d*a[12]+e*a[13]+255*a[22],b*a[15]+c*a[16]+d*a[17]+e*a[18]+255*a[23]]})}});m(l.prototype,{hue:function(a,b){j(void 0!==a,"Hue must be specified.");var c=this;b=b||!1;return this.process(function(d,e,f,g){d=c.toHSL(d,e,f);d.h=b?a/360:d.h+a/360;d=c.toRGB(d.h,
d.s,d.l);return[d.r,d.g,d.b,g]})},saturation:function(a,b){j(void 0!==a,"Saturation must be specified.");var c=this;b=b||!1;return this.process(function(d,e,f,g){d=c.toHSL(d,e,f);d.s=b?a:d.s+a;d=c.toRGB(d.h,d.s,d.l);return[d.r,d.g,d.b,g]})},brightness:function(a){j(void 0!==a,"Brightness must be set");return this.process(function(b,c,d,e){return[b+a,c+a,d+a,e]})},contrast:function(a){j(void 0!==a,"Contrast level must be set.");a=g.pow((a+100)/100,2);return this.process(function(b,c,d,e){return[255*
((b/255-0.5)*a+0.5),255*((c/255-0.5)*a+0.5),255*((d/255-0.5)*a+0.5),e]})},gamma:function(a){j(void 0!==a,"Gamma level must be set.");return this.process(function(b,c,d,e){return[b*a,c*a,d*a,e]})},gammaRGB:function(a,b,c){j(void 0!==a&&void 0!==b&&void 0!==c,"Gamma level must be set.");return this.process(function(d,e,f,g){return[d*a,e*b,f*c,g]})},vibrance:function(a){j(void 0!==a,"Vibrance level must be set.");a*=-1;return this.process(function(b,c,d,e){var f=g.max(b,c,d),h=2*g.abs(f-(b+c+d)/3)/255*
a/100;b!==f&&(b+=(f-b)*h);c!==f&&(c+=(f-c)*h);d!==f&&(d+=(f-d)*h);return[b,c,d,e]})},whiteBalance:function(a){var b=this.colorTempToRGB(a);return this.process(function(a,d,e,f){return[a*(255/b.r),d*(255/b.g),e*(255/b.b),f]})}});m(l.prototype,{convolute:function(a,b,c){j(void 0!==a,"Convolution matrix must be set.");j(void 0!==b,"Offset must be set.");c=c||!0;if(this.worker)this._toWorker({type:"convolute",matrix:a,offset:b,opaque:c});else{var d=this.ctx.getImageData(0,0,this.width,this.height),e=
g.round(g.sqrt(a.length)),f=g.floor(e/2),h=d.data,k=d.width,d=d.height,m=this.createImageData(k,d),l=m.data;c=c?1:0;for(var r=0;r<d;r++)for(var s=0;s<k;s++){for(var q=r,x=s,t=4*(r*k+s),y=0,z=0,A=0,u=0,v=0;v<e;v++)for(var w=0;w<e;w++){var n=q+v-f,p=x+w-f;0<=n&&(n<d&&0<=p&&p<k)&&(n=4*(n*k+p),p=a[v*e+w],y+=h[n]*p,z+=h[n+1]*p,A+=h[n+2]*p,u+=h[n+3]*p)}l[t]=b+y;l[t+1]=b+z;l[t+2]=b+A;l[t+3]=u+c*(255-u)}this.ctx.clearRect(0,0,this.width,this.height);this.ctx.putImageData(m,0,0)}return this},blur:function(a){j(void 0!==
a,"Blur radius must be set.");a*=a;var b=1/a,c=[];if(4>a)return this;for(;a--;)c.push(b);return this.convolute(c,0,!0)},sharpen:function(){return this.convolute([0,-1,0,-1,5,-1,0,-1,0],0,!0)},emboss:function(){return this.convolute([2,0,0,0,-1,0,0,0,-1],127,!0)},findEdges:function(){return this.convolute([-1,0,1,-2,0,2,-1,0,1],0,!0)}});q.CanvasEffects=l})(window);