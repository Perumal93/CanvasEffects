(function(q){var w=q.document,p=q.Math,l=function(b,a){for(var c in a)b[c]=a[c]},j=function(b,a){if(!b)throw Error(a||"");},k=function(b,a){j("canvas"===b.nodeName.toLowerCase(),"A canvas element is excepted.");var c={width:b.width,height:b.height,useWorker:"function"===typeof Worker,workerPath:"CanvasEffects.worker.js"};l(c,a);this.width=c.width;this.height=c.height;var d=w.createElement("canvas");d.width=this.width;d.height=this.height;this.ctx=b.getContext("2d");this.tmpCtx=d.getContext("2d");
if(c.useWorker){var e=this;this.worker=new Worker(c.workerPath);this.worker.onmessage=function(b){var c=e.ctx.createImageData(e.width,e.height);if("undefined"===typeof Uint8ClampedArray)for(var a=0;a<b.data.length;a++)c.data[a]=b.data[a];else c.data.set(b.data);e.ctx.clearRect(0,0,e.width,e.height);e.ctx.putImageData(c,0,0)};this.worker.postMessage({type:"init",w:this.width,h:this.height})}};l(k.prototype,{load:function(b,a){a=a||!0;var c=new Image,d=this;c.onload=function(){a?(d.ctx.drawImage(this,
0,0,this.width,this.height,0,0,d.width,d.height),d.tmpCtx.drawImage(this,0,0,this.width,this.height,0,0,d.width,d.height)):(d.ctx.drawImage(this,0,0,this.width,this.height),d.tmpCtx.drawImage(this,0,0,this.width,this.height))};c.crossOrigin=!0;c.src=b;return this},restore:function(){this.ctx.drawImage(this.tmpCtx.canvas,0,0,this.width,this.height);return this},save:function(){this.tmpCtx.drawImage(this.ctx.canvas,0,0,this.width,this.height)},toDataURL:function(){return this.ctx.canvas.toDataURL()},
process:function(b){for(var a=this.ctx.getImageData(0,0,this.width,this.height),c=0;c<a.data.length;c+=4){var d=b(a.data[c],a.data[c+1],a.data[c+2],a.data[c+3]);a.data[c]=d[0];a.data[c+1]=d[1];a.data[c+2]=d[2];a.data[c+3]=d[3]}this.ctx.clearRect(0,0,this.width,this.height);this.ctx.putImageData(a,0,0);return this},getContext:function(){return this.ctx},luminance:function(b,a,c){return 0.2126*b+0.7152*a+0.0722*c},createImageData:function(b,a){return this.tmpCtx.createImageData(b,a)},toHSL:function(b,
a,c){b/=255;a/=255;c/=255;var d=p.max(b,a,c),e=p.min(b,a,c),f,g=(d+e)/2;if(d===e)f=e=0;else{var h=d-e,e=0.5<g?h/(2-d-e):h/(d+e);switch(d){case b:f=(a-c)/h+(a<c?6:0);break;case a:f=(c-b)/h+2;break;case c:f=(b-a)/h+4}}return{h:f/6,s:e,l:g}},toRGB:function(b,a,c){if(0==a)c=a=b=c;else{var d=function(b,c,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?b+6*(c-b)*a:0.5>a?c:a<2/3?b+6*(c-b)*(2/3-a):b},e=0.5>c?c*(1+a):c+a-c*a,f=2*c-e;c=d(f,e,b+1/3);a=d(f,e,b);b=d(f,e,b-1/3)}return{r:255*c,g:255*a,b:255*b}}});l(k.prototype,
{greyscale:function(){var b=this;return this.process(function(a,c,d,e){a=b.luminance(a,c,d);return[a,a,a,e]})},threshold:function(b){b=b||127;var a=this;return this.process(function(c,d,e,f){c=a.luminance(c,d,e)>b?255:0;return[c,c,c,f]})},invert:function(){return this.process(function(b,a,c,d){return[255-b,255-a,255-c,d]})},sepia:function(b){b=p.max(p.min(b||1,1),0);return this.process(function(a,c,d,e){return[(0.393*a+0.769*c+0.189*d)*b+a*(1-b),(0.349*a+0.686*c+0.168*d)*b+c*(1-b),(0.272*a+0.534*
c+0.131*d)*b+d*(1-b),e]})}});l(k.prototype,{hue:function(b,a){j(void 0!==b,"Hue must be specified.");var c=this;a=a||!1;return this.process(function(d,e,f,g){d=c.toHSL(d,e,f);d.h=a?b/360:d.h+b/360;d=c.toRGB(d.h,d.s,d.l);return[d.r,d.g,d.b,g]})},saturation:function(b,a){j(void 0!==b,"Saturation must be specified.");var c=this;a=a||!1;return this.process(function(d,e,f,g){d=c.toHSL(d,e,f);d.s=a?b:d.s+b;d=c.toRGB(d.h,d.s,d.l);return[d.r,d.g,d.b,g]})},brightness:function(b){j(void 0!==b,"Brightness must be set");
return this.process(function(a,c,d,e){return[a+b,c+b,d+b,e]})},contrast:function(b){var a=this;return this.process(function(c,d,e,f){127>a.luminance(c,d,e,f)&&(b=-b);return[c+b,d+b,e+b,f]})},gamma:function(b){return this.process(function(a,c,d,e){return[a*b,c*b,d*b,e]})},gammaRGB:function(b,a,c){return this.process(function(d,e,f,g){return[d*b,e*a,f*c,g]})}});l(k.prototype,{convolute:function(b,a,c){c=c||!0;var d=this.ctx.getImageData(0,0,this.width,this.height),e=p.round(p.sqrt(b.length)),f=p.floor(e/
2),g=d.data,h=d.width,d=d.height;if(this.worker)this.worker.postMessage({type:"convolute",data:g,matrix:b,offset:a,opaque:c});else{var l=this.createImageData(h,d),j=l.data;c=c?1:0;for(var k=0;k<d;k++)for(var r=0;r<h;r++){for(var q=k,w=r,s=4*(k*h+r),x=0,y=0,z=0,t=0,u=0;u<e;u++)for(var v=0;v<e;v++){var m=q+u-f,n=w+v-f;0<=m&&(m<d&&0<=n&&n<h)&&(m=4*(m*h+n),n=b[u*e+v],x+=g[m]*n,y+=g[m+1]*n,z+=g[m+2]*n,t+=g[m+3]*n)}j[s]=a+x;j[s+1]=a+y;j[s+2]=a+z;j[s+3]=t+c*(255-t)}this.ctx.clearRect(0,0,this.width,this.height);
this.ctx.putImageData(l,0,0)}return this},blur:function(b){j(void 0!==b,"Level must be set.");b*=b;var a=1/b,c=[];if(4>b)return this;for(;b--;)c.push(a);return this.convolute(c,0,!0)},sharpen:function(){return this.convolute([0,-1,0,-1,5,-1,0,-1,0],0,!0)},emboss:function(){return this.convolute([2,0,0,0,-1,0,0,0,-1],127,!0)},findEdges:function(){return this.convolute([-1,0,1,-2,0,2,-1,0,1],0,!0)}});q.CanvasEffects=k})(window);